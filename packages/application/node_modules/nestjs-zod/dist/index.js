"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@nestjs/common"),t=require("merge-deep"),r=require("zod");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=s(t);function i(e){return null==e?void 0:e.isZodDto}class a extends e.BadRequestException{constructor(t){super({statusCode:e.HttpStatus.BAD_REQUEST,message:"Validation failed",errors:t.errors}),this.error=t}getZodError(){return this.error}}const o=e=>new a(e);function d(e,t,r=o){const s=(i(t)?t.schema:t).safeParse(e);if(!s.success)throw r(s.error);return s.data}var c=Object.defineProperty,u=Object.getOwnPropertyDescriptor;function m({createValidationException:t}={}){let r=class{constructor(e,t){this.source=e,this.schemaOrDto=t}canActivate(e){return d(e.switchToHttp().getRequest()[this.source],this.schemaOrDto,t),!0}};return r=((e,t,r,s)=>{for(var n,i=s>1?void 0:s?u(t,r):t,a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s?n(t,r,i):n(i))||i);return s&&i&&c(t,r,i),i})([e.Injectable()],r),r}const l=m();function p(e){return t=>{if(!function(e){var t;return"custom"===e.code&&(null==(t=e.params)?void 0:t.isNestJsZod)}(t))return{matched:!1};const r=e(t.params);return r.matched?r:{matched:!1}}}function f(e,t){return s=>{if(s.code!==r.ZodIssueCode.too_small&&s.code!==r.ZodIssueCode.too_big)return{matched:!1};if(s.type!==e)return{matched:!1};const n=t(s);return n.matched?n:{matched:!1}}}const h=p((e=>{if("invalid_date_string"===e.code){return{matched:!0,message:"Invalid string, expected it to be a valid date"}}if("invalid_date_string_format"===e.code){return{matched:!0,message:`Invalid date, expected it to match ${{date:'YYYY-MM-DD (RFC3339 "full-date")',"date-time":'YYYY-MM-DDTHH:mm:ssZ (RFC3339 "date-time")'}[e.expected]}`}}if("invalid_date_string_direction"===e.code){return{matched:!0,message:`Invalid date, expected it to be the ${e.expected}`}}if("invalid_date_string_day"===e.code){return{matched:!0,message:`Invalid date, expected it to be a ${{weekDay:"week day",weekend:"weekend"}[e.expected]}`}}return{matched:!1}})),g=f("date_string_year",(e=>{if(e.code===r.ZodIssueCode.too_small){return{matched:!0,message:`Year must be greater than ${e.inclusive?"or equal to ":""}${e.minimum}`}}if(e.code===r.ZodIssueCode.too_big){return{matched:!0,message:`Year must be less than ${e.inclusive?"or equal to ":""}${e.maximum}`}}return{matched:!1}})),_=p((e=>{if("invalid_password_no_digit"===e.code){return{matched:!0,message:"Password must contain at least one digit"}}if("invalid_password_no_lowercase"===e.code){return{matched:!0,message:"Password must contain at least one lowercase letter"}}if("invalid_password_no_uppercase"===e.code){return{matched:!0,message:"Password must contain at least one uppercase letter"}}if("invalid_password_no_special"===e.code){return{matched:!0,message:"Password must contain at least one special symbol"}}return{matched:!1}})),y=f("password",(e=>{if(e.code===r.ZodIssueCode.too_small){return{matched:!0,message:`Password length must be greater than ${e.inclusive?"or equal to ":""}${e.minimum}`}}if(e.code===r.ZodIssueCode.too_big){return{matched:!0,message:`Password length must be less than ${e.inclusive?"or equal to ":""}${e.maximum}`}}return{matched:!1}})),v=(k=[h,g,_,y],e=>{for(const t of k){const r=t(e);if(r.matched)return r}return{matched:!1}});var k;var Z;function b(e,t){r.addIssueToContext(e,t)}function x(e){return"string"==typeof e?{message:e}:e}function w(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:s,description:n}=e;if(t&&(r||s))throw new Error('Can\'t use "invalid" or "required" in conjunction with custom error map.');if(t)return{errorMap:t,description:n};return{errorMap:(t,r)=>"invalid_type"!==t.code?{message:r.defaultError}:void 0===r.data&&s?{message:s}:e.invalid_type_error?{message:e.invalid_type_error}:{message:r.defaultError},description:n}}function O(e,t){return e.find((e=>e.kind===t))}Z=(e,t)=>{const s=v(e);return s.matched?{message:s.message}:r.defaultErrorMap(e,t)},r.setErrorMap(Z),r.z.union([r.z.string(),r.z.number(),r.z.boolean()]);var I=(e=>(e.ZodDateString="ZodDateString",e.ZodPassword="ZodPassword",e))(I||{}),j=Object.defineProperty,D=Object.defineProperties,C=Object.getOwnPropertyDescriptors,P=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,Y=(e,t,r)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,N=(e,t)=>{for(var r in t||(t={}))L.call(t,r)&&Y(e,r,t[r]);if(P)for(var r of P(t))T.call(t,r)&&Y(e,r,t[r]);return e};const E={date:/^\d{4}-\d{2}-\d{2}$/,"date-time":/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(|\.\d{3})(Z|[+-]\d{2}:\d{2})$/},$=class extends r.ZodType{_parse(e){const t=this._getType(e),s=this._getOrReturnCtx(e);if(t!==r.ZodParsedType.string)return b(s,{code:r.ZodIssueCode.invalid_type,expected:r.ZodParsedType.string,received:s.parsedType}),r.INVALID;const n=new Date(e.data);if(Number.isNaN(n.getTime()))return b(s,{code:r.ZodIssueCode.custom,message:"Invalid date string",params:{isNestJsZod:!0,code:"invalid_date_string"}}),r.INVALID;const i=new r.ParseStatus;for(const t of this._def.checks)if("format"===t.kind){if(t.regex.test(e.data))continue;b(s,{code:r.ZodIssueCode.custom,message:t.message,params:{isNestJsZod:!0,code:"invalid_date_string_format",expected:t.value}}),i.dirty()}else if("direction"===t.kind){if({past:n<new Date,future:n>new Date}[t.direction])continue;b(s,{code:r.ZodIssueCode.custom,message:t.message,params:{isNestJsZod:!0,code:"invalid_date_string_direction",expected:t.direction}}),i.dirty()}else if("day-type"===t.kind){const e=n.getDay();if({weekDay:0!==e&&6!==e,weekend:0===e||6===e}[t.type])continue;b(s,{code:r.ZodIssueCode.custom,message:t.message,params:{isNestJsZod:!0,code:"invalid_date_string_day",expected:t.type}}),i.dirty()}else if("minYear"===t.kind){if(n.getFullYear()>=t.value)continue;b(s,{code:r.ZodIssueCode.too_small,type:"date_string_year",minimum:t.value,inclusive:!0,message:t.message}),i.dirty()}else if("maxYear"===t.kind){if(n.getFullYear()<=t.value)continue;b(s,{code:r.ZodIssueCode.too_big,type:"date_string_year",maximum:t.value,inclusive:!0,message:t.message}),i.dirty()}return{status:i.value,value:e.data}}_replaceCheck(e){return new $((t=N({},this._def),r={checks:this._def.checks.filter((t=>t.kind!==e.kind)).concat(e)},D(t,C(r))));var t,r}format(e,t){return this._replaceCheck(N({kind:"format",value:e,regex:E[e]},x(t)))}past(e){return this._replaceCheck(N({kind:"direction",direction:"past"},x(e)))}future(e){return this._replaceCheck(N({kind:"direction",direction:"future"},x(e)))}weekDay(e){return this._replaceCheck(N({kind:"day-type",type:"weekDay"},x(e)))}weekend(e){return this._replaceCheck(N({kind:"day-type",type:"weekend"},x(e)))}minYear(e,t){return this._replaceCheck(N({kind:"minYear",value:e},x(t)))}maxYear(e,t){return this._replaceCheck(N({kind:"maxYear",value:e},x(t)))}cast(){return this.transform((e=>new Date(e)))}get format_(){return O(this._def.checks,"format")}get isPast(){var e;return"past"===(null==(e=O(this._def.checks,"direction"))?void 0:e.direction)}get isFuture(){var e;return"future"===(null==(e=O(this._def.checks,"direction"))?void 0:e.direction)}get isWeekDay(){var e;return"weekDay"===(null==(e=O(this._def.checks,"day-type"))?void 0:e.type)}get isWeekend(){var e;return"weekend"===(null==(e=O(this._def.checks,"day-type"))?void 0:e.type)}get minYear_(){return O(this._def.checks,"minYear")}get maxYear_(){return O(this._def.checks,"maxYear")}};let q=$;q.create=e=>new $(N({checks:[{kind:"format",value:"date-time",regex:E["date-time"]}],typeName:I.ZodDateString},w(e))),q.create;var S=Object.defineProperty,M=Object.defineProperties,z=Object.getOwnPropertyDescriptors,R=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable,F=(e,t,r)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,B=(e,t)=>{for(var r in t||(t={}))V.call(t,r)&&F(e,r,t[r]);if(R)for(var r of R(t))A.call(t,r)&&F(e,r,t[r]);return e};const J=["digit","lowercase","uppercase","special"],U={digit:/\d/,lowercase:/[a-z]/,uppercase:/[A-Z]/,special:/[!?@#$%^&*{};.,:%â„–"|\\/()-_+=<>`~[\]'"]/};function G(e){return J.includes(e.kind)}const H=class extends r.ZodType{_parse(e){const t=this._getType(e),s=this._getOrReturnCtx(e);if(t!==r.ZodParsedType.string)return b(s,{code:r.ZodIssueCode.invalid_type,expected:r.ZodParsedType.string,received:s.parsedType}),r.INVALID;const n=new r.ParseStatus;for(const t of this._def.checks)if(G(t)){if(U[t.kind].test(e.data))continue;b(s,{code:r.ZodIssueCode.custom,message:t.message,params:{isNestJsZod:!0,code:`invalid_password_no_${t.kind}`}}),n.dirty()}else if("minLength"===t.kind){if(e.data.length>=t.value)continue;b(s,{code:r.ZodIssueCode.too_small,type:"password",minimum:t.value,inclusive:!0,message:t.message}),n.dirty()}else if("maxLength"===t.kind){if(e.data.length<=t.value)continue;b(s,{code:r.ZodIssueCode.too_big,type:"password",maximum:t.value,inclusive:!0,message:t.message}),n.dirty()}return{status:n.value,value:e.data}}_replaceCheck(e){return new H((t=B({},this._def),r={checks:this._def.checks.filter((t=>t.kind!==e.kind)).concat(e)},M(t,z(r))));var t,r}buildFullRegExp(){const e=[];for(const t of this._def.checks){if(!G(t))continue;const r=U[t.kind];e.push(`(?=.*${r.source})`)}if(0===e.length)return/^.*$/;const t=e.join("");return new RegExp(`^(?:${t}.*)$`)}atLeastOne(e,t){return this._replaceCheck(B({kind:e},x(t)))}min(e,t){return this._replaceCheck(B({kind:"minLength",value:e},x(t)))}max(e,t){return this._replaceCheck(B({kind:"maxLength",value:e},x(t)))}isAtLeastOne(e){return function(e,t){return Boolean(O(e,t))}(this._def.checks,e)}get minLength(){return O(this._def.checks,"minLength")}get maxLength(){return O(this._def.checks,"maxLength")}};let W=H;function Q(e,t){return t.name===e._def.typeName}function K(e){const t={};if(e.description&&(t.description=e.description),Q(e,r.ZodString)){const{checks:r}=e._def;t.type="string";for(const e of r)"min"===e.kind?t.minLength=e.value:"max"===e.kind?t.maxLength=e.value:"email"===e.kind?t.format="email":"url"===e.kind?t.format="uri":"uuid"===e.kind?t.format="uuid":"cuid"===e.kind?t.format="cuid":"regex"===e.kind&&(t.pattern=e.regex.source)}if(Q(e,W)){const{checks:r}=e._def,s=e.buildFullRegExp();t.type="string",t.format="password",t.pattern=s.source;for(const e of r)"minLength"===e.kind?t.minLength=e.value:"maxLength"===e.kind&&(t.maxLength=e.value)}if(Q(e,r.ZodBoolean)&&(t.type="boolean"),Q(e,r.ZodNumber)){const{checks:r}=e._def;t.type="number";for(const e of r)"int"===e.kind?t.type="integer":"min"===e.kind?(t.minimum=e.value,t.exclusiveMinimum=!e.inclusive):"max"===e.kind?(t.maximum=e.value,t.exclusiveMaximum=!e.inclusive):"multipleOf"===e.kind&&(t.multipleOf=e.value)}if(Q(e,q)){const{checks:r}=e._def;t.type="string";for(const e of r)"format"===e.kind&&(t.format=e.value)}if(Q(e,r.ZodBigInt)&&(t.type="integer",t.format="int64"),Q(e,r.ZodArray)){const{minLength:r,maxLength:s,type:n}=e._def;t.type="array",r&&(t.minItems=r.value),s&&(t.maxItems=s.value),t.items=K(n)}if(Q(e,r.ZodTuple)){const{items:r}=e._def;t.type="array",t.items={oneOf:r.map(K)}}if(Q(e,r.ZodSet)){const{valueType:r,minSize:s,maxSize:n}=e._def;t.type="array",s&&(t.minItems=s.value),n&&(t.maxItems=n.value),t.items=K(r),t.uniqueItems=!0}if(Q(e,r.ZodUnion)){const{options:r}=e._def;t.oneOf=r.map(K)}if(Q(e,r.ZodDiscriminatedUnion)){const{options:r}=e._def;t.oneOf=[];for(const e of r.values())t.oneOf.push(K(e))}if(Q(e,r.ZodLiteral)){const{value:r}=e._def;"string"==typeof r&&(t.type="string",t.enum=[r]),"number"==typeof r&&(t.type="number",t.minimum=r,t.maximum=r),"boolean"==typeof r&&(t.type="boolean")}if(Q(e,r.ZodEnum)){const{values:r}=e._def;t.type="string",t.enum=r}if(Q(e,r.ZodNativeEnum)){const{values:r}=e._def;t.type="string",t.enum=Object.values(r)}if(Q(e,r.ZodTransformer)){const{schema:r}=e._def;Object.assign(t,K(r))}if(Q(e,r.ZodNullable)){const{innerType:r}=e._def;Object.assign(t,K(r)),t.nullable=!0}if(Q(e,r.ZodOptional)){const{innerType:r}=e._def;Object.assign(t,K(r))}if(Q(e,r.ZodDefault)){const{defaultValue:r,innerType:s}=e._def;Object.assign(t,K(s)),t.default=r()}if(Q(e,r.ZodObject)){const{shape:s}=e._def;t.type="object",t.properties={},t.required=[];for(const[e,n]of Object.entries(s())){t.properties[e]=K(n);[r.ZodOptional.name,r.ZodDefault.name].includes(n.constructor.name)||t.required.push(e)}0===t.required.length&&delete t.required}if(Q(e,r.ZodRecord)){const{valueType:r}=e._def;t.type="object",t.additionalProperties=K(r)}if(Q(e,r.ZodIntersection)){const{left:r,right:s}=e._def,i=n.default(K(r),K(s));Object.assign(t,i)}if(Q(e,r.ZodEffects)){const{schema:r}=e._def;Object.assign(t,K(r))}if(Q(e,r.ZodLazy)){const{getter:r}=e._def;Object.assign(t,K(r()))}return t}W.create=e=>new H(B({checks:[],typeName:I.ZodPassword},w(e))),W.create;var X=Object.defineProperty,ee=Object.getOwnPropertyDescriptor;function te({createValidationException:t}={}){let r=class{constructor(e){this.schemaOrDto=e}transform(e,r){if(this.schemaOrDto)return d(e,this.schemaOrDto,t);const{metatype:s}=r;return i(s)?d(e,s.schema,t):e}};return r=((e,t,r,s)=>{for(var n,i=s>1?void 0:s?ee(t,r):t,a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s?n(t,r,i):n(i))||i);return s&&i&&X(t,r,i),i})([e.Injectable()],r),r}const re=te();exports.UseZodGuard=(t,r)=>e.UseGuards(new l(t,r)),exports.ZodGuard=l,exports.ZodValidationException=a,exports.ZodValidationPipe=re,exports.createZodDto=function(e){class t{static create(e){return this.schema.parse(e)}}return t.isZodDto=!0,t.schema=e,t},exports.createZodGuard=m,exports.createZodValidationPipe=te,exports.patchNestJsSwagger=function(e=function(){return require("@nestjs/swagger/dist/services/schema-object-factory").SchemaObjectFactory}()){if(e.prototype.__patchedWithLoveByNestjsZod)return;const t=e.prototype.exploreModelSchema;e.prototype.exploreModelSchema=function(e,r,s){if(this&&this.isLazyTypeFunc(e)){e=e()}return i(e)?(r[e.name]=K(e.schema),e.name):t(e,r,s)},e.prototype.__patchedWithLoveByNestjsZod=!0},exports.validate=d,exports.zodToOpenAPI=K;
